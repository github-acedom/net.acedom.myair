<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
</head>
<body>
    <header class="homey-header">
        <h1 class="homey-title" data-i18n="settings.title">MyAir Settings</h1>
        <p class="homey-subtitle" data-i18n="settings.subtitle">Configure your MyAir device IP address and settings</p>
    </header>

    <fieldset class="homey-form-fieldset">
        <legend class="homey-form-legend">IP Address Configuration</legend>

        <div class="homey-form-group">
            <label class="homey-form-label" for="myAirIp">MyAir IP Address</label>
            <input class="homey-form-input" id="myAirIp" type="text" value="" placeholder="192.168.x.x"/>
        </div>

        
    </fieldset>
    <fieldset class="homey-form-fieldset">
    <legend class="homey-form-legend">Other Settings</legend>
        <div class="homey-form-group">
            <label class="homey-form-label" for="pollingInterval">Polling Interval (seconds) <i>Requires app restart to take effect</i></label>
            <input class="homey-form-input" id="pollingInterval" type="number" min="60" value="60"/>
        </div>
        <div class="homey-form-group">
            <label class="homey-form-label" for="requestTimeout">Request Timeout (seconds) <i>Requires app restart to take effect</i></label>
            <input class="homey-form-input" id="requestTimeout" type="number" min="1" value="5"/>
        </div>
    </fieldset>

    <button id="save" class="homey-button-primary-full">Save changes</button>

    <script type="text/javascript">
        function onHomeyReady(Homey) {
            Homey.ready(); // Indicate the settings page is loaded

            const myAirIpElement = document.getElementById('myAirIp');
            const pollingIntervalElement = document.getElementById('pollingInterval');
            const requestTimeoutElement = document.getElementById('requestTimeout');
            const saveElement = document.getElementById('save');

            // Load the current MyAir IP address setting
            Homey.get('myAirIp', function (err, myAirIp) {
                if (err) return Homey.alert(err);
                myAirIpElement.value = myAirIp || '';
            });

            // Load existing settings
            Homey.get('pollingInterval', function (err, value) {
                if (err) return Homey.alert(err);
                if (value) pollingIntervalElement.value = value / 1000; // Convert to seconds for display
            });

            Homey.get('requestTimeout', function (err, value) {
                if (err) return Homey.alert(err);
                if (value) requestTimeoutElement.value = value / 1000; // Convert to seconds for display
            });

            // Save settings in one handler
            saveElement.addEventListener('click', function () {
                const newIp = myAirIpElement.value.trim();
                const ipRegex = /^(\\d{1,3}\\.){3}\\d{1,3}$/;
                if (!newIp || !ipRegex.test(newIp)) {
                    return Homey.alert('Please enter a valid IP address.');
                }

                const pollingIntervalSeconds = parseInt(pollingIntervalElement.value, 10);
                const pollingIntervalMillis = pollingIntervalSeconds * 1000; // Convert to milliseconds for storage
                // Ensure the interval is not less than 60 seconds
                const intervalToSave = isNaN(pollingIntervalMillis) || pollingIntervalMillis < 60000 ? 60000 : pollingIntervalMillis;

                const requestTimeoutSeconds = parseInt(requestTimeoutElement.value, 10);
                const requestTimeoutMillis = requestTimeoutSeconds * 1000; // Convert to milliseconds for storage
                // Ensure the timeout is not less than 1 second
                const timeoutToSave = isNaN(requestTimeoutMillis) || requestTimeoutMillis < 1000 ? 1000 : requestTimeoutMillis;

                Homey.set('myAirIp', newIp, function (err) {
                    if (err) return Homey.alert(err);

                    Homey.set('pollingInterval', intervalToSave, function (err) {
                        if (err) return Homey.alert(err);

                        Homey.set('requestTimeout', timeoutToSave, function (err) {
                            if (err) return Homey.alert(err);
                            Homey.alert('Settings saved successfully! (Restart app to apply timing changes)');
                        });
                    });
                });
            });
        }
    </script>
</body>
</html>
